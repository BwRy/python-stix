import unittest
from stix.test import EntityTestCase
from stix.extensions.malware.maec_4_1_malware import MAECInstance

STIX_MAEC_XML = """<stix-maec:MAEC xmlns:maecPackage="http://maec.mitre.org/XMLSchema/maec-package-2" xmlns:maecBundle="http://maec.mitre.org/XMLSchema/maec-bundle-4" xmlns:maecVocabs="http://maec.mitre.org/default_vocabularies-1" xmlns:cybox="http://cybox.mitre.org/cybox-2" xmlns:cyboxCommon="http://cybox.mitre.org/common-2" xmlns:cyboxVocabs="http://cybox.mitre.org/default_vocabularies-2" xmlns:FileObj="http://cybox.mitre.org/objects#FileObject-2" xmlns:WinExecFileObj="http://cybox.mitre.org/objects#WinExecutableFileObject-2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:stix-maec="http://stix.mitre.org/extensions/Malware#MAEC4.1-1" xsi:schemaLocation="http://maec.mitre.org/XMLSchema/maec-package-2 http://maec.mitre.org/language/version4.1/maec_package_schema.xsd                     http://maec.mitre.org/default_vocabularies-1 http://maec.mitre.org/language/version4.1/maec_default_vocabularies.xsd                     http://cybox.mitre.org/default_vocabularies-2 http://cybox.mitre.org/XMLSchema/default_vocabularies/2.1/cybox_default_vocabularies.xsd                      http://cybox.mitre.org/objects#WinExecutableFileObject http://cybox.mitre.org/XMLSchema/objects/Win_Executable_File/2.1/Win_Executable_File_Object.xsd" id="maec-example-pkg-1" schema_version="2.1">
                   </stix-maec:MAEC>"""

MAEC_XML = """<maecPackage:MAEC_Package
                    xmlns:maecPackage="http://maec.mitre.org/XMLSchema/maec-package-2"
                    xmlns:maecBundle="http://maec.mitre.org/XMLSchema/maec-bundle-4"
                    xmlns:maecVocabs="http://maec.mitre.org/default_vocabularies-1"
                    xmlns:cybox="http://cybox.mitre.org/cybox-2"
                    xmlns:cyboxCommon="http://cybox.mitre.org/common-2"
                    xmlns:cyboxVocabs="http://cybox.mitre.org/default_vocabularies-2"
                    xmlns:FileObj="http://cybox.mitre.org/objects#FileObject-2"
                    xmlns:WinExecFileObj="http://cybox.mitre.org/objects#WinExecutableFileObject-2"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maec.mitre.org/XMLSchema/maec-package-2 http://maec.mitre.org/language/version4.1/maec_package_schema.xsd
                    http://maec.mitre.org/default_vocabularies-1 http://maec.mitre.org/language/version4.1/maec_default_vocabularies.xsd
                    http://cybox.mitre.org/default_vocabularies-2 http://cybox.mitre.org/XMLSchema/default_vocabularies/2.1/cybox_default_vocabularies.xsd 
                    http://cybox.mitre.org/objects#WinExecutableFileObject http://cybox.mitre.org/XMLSchema/objects/Win_Executable_File/2.1/Win_Executable_File_Object.xsd" 
                    id="maec-example-pkg-1" schema_version="2.1">

                    <maecPackage:Malware_Subjects>
                    <maecPackage:Malware_Subject id="maec-example-sub-1">
                    <maecPackage:Malware_Instance_Object_Attributes>
                        <cybox:Properties xsi:type="WinExecFileObj:WindowsExecutableFileObjectType">
                        <FileObj:File_Name>dg003_improve_8080_V132.exe</FileObj:File_Name>
                        <FileObj:Size_In_Bytes>196608</FileObj:Size_In_Bytes>
                        <FileObj:Hashes>
                        <cyboxCommon:Hash>
                        <cyboxCommon:Type xsi:type="cyboxVocabs:HashNameVocab-1.0">MD5</cyboxCommon:Type>
                        <cyboxCommon:Simple_Hash_Value>4EC0027BEF4D7E1786A04D021FA8A67F</cyboxCommon:Simple_Hash_Value>
                        </cyboxCommon:Hash>
                        </FileObj:Hashes>
                        <FileObj:Packer_List>
                        <FileObj:Packer>
                        <FileObj:Name>UPX</FileObj:Name>
                        <FileObj:Signature>UPX v3.0.2</FileObj:Signature>
                        </FileObj:Packer>
                        </FileObj:Packer_List>
                        </cybox:Properties>
                    </maecPackage:Malware_Instance_Object_Attributes>
   
                    <maecPackage:Label xsi:type="maecVocabs:MalwareLabelVocab-1.0">dropper file</maecPackage:Label>
   
                    <maecPackage:Analyses>
                    <maecPackage:Analysis id="maec-example-ana-1" method="static" type="triage">
                        <maecPackage:Source>
                        <maecPackage:Name>Frankie Li</maecPackage:Name>
                        <maecPackage:URL>http://www.sans.org/reading_room/whitepapers/malicious/detailed-analysis-advanced-persistent-threat-malware_33814</maecPackage:URL>
                        </maecPackage:Source>
                        <maecPackage:Summary>A basic static triage of the subject binary using PEiD.</maecPackage:Summary>
                        <maecPackage:Findings_Bundle_Reference bundle_idref="maec-example-bnd-1"/>
                        <maecPackage:Tools>
                        <maecPackage:Tool id="analysis-tool-1">
                        <cyboxCommon:Name>PEiD</cyboxCommon:Name>
                        <cyboxCommon:Version>0.94</cyboxCommon:Version>
                        </maecPackage:Tool>
                        </maecPackage:Tools>
                    </maecPackage:Analysis>
                    </maecPackage:Analyses>
   
                    <maecPackage:Findings_Bundles>
                    <maecPackage:Bundle id="maec-example-bnd-1" schema_version="4.1" defined_subject="false" content_type="extracted from subject">
                        <maecBundle:Objects>
                        <maecBundle:Object id="maec-example-obj-1">
                        <cybox:Properties xsi:type="WinExecFileObj:WindowsExecutableFileObjectType">
                            <WinExecFileObj:Headers>
                            <WinExecFileObj:Optional_Header>
                            <WinExecFileObj:Major_Linker_Version>06</WinExecFileObj:Major_Linker_Version>
                            <WinExecFileObj:Minor_Linker_Version>00</WinExecFileObj:Minor_Linker_Version>
                            <WinExecFileObj:Base_Of_Code>036418</WinExecFileObj:Base_Of_Code>
                            <WinExecFileObj:Subsystem>Windows_GUI</WinExecFileObj:Subsystem>
                            </WinExecFileObj:Optional_Header>
                            </WinExecFileObj:Headers>
                            <WinExecFileObj:Type>Executable</WinExecFileObj:Type>
                        </cybox:Properties>
                        </maecBundle:Object>
                        </maecBundle:Objects>
                    </maecPackage:Bundle>
                    </maecPackage:Findings_Bundles>
                    </maecPackage:Malware_Subject>
                    </maecPackage:Malware_Subjects>
                </maecPackage:MAEC_Package>
                """

MALWARE_INSTANCE_OUT = """<stix-maec:MAEC4.1InstanceType  xmlns:cyboxCommon="http://cybox.mitre.org/common-2" xmlns:cybox="http://cybox.mitre.org/cybox-2" xmlns:cyboxVocabs="http://cybox.mitre.org/default_vocabularies-2" xmlns:example="http://example.com" xmlns:maecBundle="http://maec.mitre.org/XMLSchema/maec-bundle-4" xmlns:maecVocabs="http://maec.mitre.org/default_vocabularies-1" xmlns:ttp="http://stix.mitre.org/TTP-1" xmlns:stixCommon="http://stix.mitre.org/common-1" xmlns:stixVocabs="http://stix.mitre.org/default_vocabularies-1" xmlns:stix-maec="http://stix.mitre.org/extensions/Malware#MAEC4.1-1" xmlns:stix="http://stix.mitre.org/stix-1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation=" http://cybox.mitre.org/common-2 http://cybox.mitre.org/XMLSchema/common/2.1/cybox_common.xsd http://cybox.mitre.org/cybox-2 http://cybox.mitre.org/XMLSchema/core/2.1/cybox_core.xsd http://cybox.mitre.org/default_vocabularies-2 http://cybox.mitre.org/XMLSchema/default_vocabularies/2.1/cybox_default_vocabularies.xsd http://cybox.mitre.org/objects#WinExecutableFileObject http://cybox.mitre.org/XMLSchema/objects/Win_Executable_File/2.1/Win_Executable_File_Object.xsd http://maec.mitre.org/XMLSchema/maec-package-2 http://maec.mitre.org/language/version4.1/maec_package_schema.xsd http://maec.mitre.org/default_vocabularies-1 http://maec.mitre.org/language/version4.1/maec_default_vocabularies.xsd http://stix.mitre.org/TTP-1 http://stix.mitre.org/XMLSchema/ttp/1.1.1/ttp.xsd http://stix.mitre.org/common-1 http://stix.mitre.org/XMLSchema/common/1.1.1/stix_common.xsd http://stix.mitre.org/default_vocabularies-1 http://stix.mitre.org/XMLSchema/default_vocabularies/1.1.1/stix_default_vocabularies.xsd http://stix.mitre.org/extensions/Malware#MAEC4.1-1 http://stix.mitre.org/XMLSchema/extensions/malware/maec_4.1/1.0.1/maec_4.1_malware.xsd http://stix.mitre.org/stix-1 http://stix.mitre.org/XMLSchema/core/1.1.1/stix_core.xsd" xsi:type='stix-maec:MAEC4.1InstanceType'><stix-maec:MAEC xmlns:maecPackage="http://maec.mitre.org/XMLSchema/maec-package-2" xmlns:maecBundle="http://maec.mitre.org/XMLSchema/maec-bundle-4" xmlns:maecVocabs="http://maec.mitre.org/default_vocabularies-1" xmlns:cybox="http://cybox.mitre.org/cybox-2" xmlns:cyboxCommon="http://cybox.mitre.org/common-2" xmlns:cyboxVocabs="http://cybox.mitre.org/default_vocabularies-2" xmlns:FileObj="http://cybox.mitre.org/objects#FileObject-2" xmlns:WinExecFileObj="http://cybox.mitre.org/objects#WinExecutableFileObject-2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:stix-maec="http://stix.mitre.org/extensions/Malware#MAEC4.1-1" xsi:schemaLocation="http://maec.mitre.org/XMLSchema/maec-package-2 http://maec.mitre.org/language/version4.1/maec_package_schema.xsd                     http://maec.mitre.org/default_vocabularies-1 http://maec.mitre.org/language/version4.1/maec_default_vocabularies.xsd                     http://cybox.mitre.org/default_vocabularies-2 http://cybox.mitre.org/XMLSchema/default_vocabularies/2.1/cybox_default_vocabularies.xsd                      http://cybox.mitre.org/objects#WinExecutableFileObject http://cybox.mitre.org/XMLSchema/objects/Win_Executable_File/2.1/Win_Executable_File_Object.xsd" id="maec-example-pkg-1" schema_version="2.1">

                    <maecPackage:Malware_Subjects>
                    <maecPackage:Malware_Subject id="maec-example-sub-1">
                    <maecPackage:Malware_Instance_Object_Attributes>
                        <cybox:Properties xsi:type="WinExecFileObj:WindowsExecutableFileObjectType">
                        <FileObj:File_Name>dg003_improve_8080_V132.exe</FileObj:File_Name>
                        <FileObj:Size_In_Bytes>196608</FileObj:Size_In_Bytes>
                        <FileObj:Hashes>
                        <cyboxCommon:Hash>
                        <cyboxCommon:Type xsi:type="cyboxVocabs:HashNameVocab-1.0">MD5</cyboxCommon:Type>
                        <cyboxCommon:Simple_Hash_Value>4EC0027BEF4D7E1786A04D021FA8A67F</cyboxCommon:Simple_Hash_Value>
                        </cyboxCommon:Hash>
                        </FileObj:Hashes>
                        <FileObj:Packer_List>
                        <FileObj:Packer>
                        <FileObj:Name>UPX</FileObj:Name>
                        <FileObj:Signature>UPX v3.0.2</FileObj:Signature>
                        </FileObj:Packer>
                        </FileObj:Packer_List>
                        </cybox:Properties>
                    </maecPackage:Malware_Instance_Object_Attributes>
   
                    <maecPackage:Label xsi:type="maecVocabs:MalwareLabelVocab-1.0">dropper file</maecPackage:Label>
   
                    <maecPackage:Analyses>
                    <maecPackage:Analysis id="maec-example-ana-1" method="static" type="triage">
                        <maecPackage:Source>
                        <maecPackage:Name>Frankie Li</maecPackage:Name>
                        <maecPackage:URL>http://www.sans.org/reading_room/whitepapers/malicious/detailed-analysis-advanced-persistent-threat-malware_33814</maecPackage:URL>
                        </maecPackage:Source>
                        <maecPackage:Summary>A basic static triage of the subject binary using PEiD.</maecPackage:Summary>
                        <maecPackage:Findings_Bundle_Reference bundle_idref="maec-example-bnd-1"/>
                        <maecPackage:Tools>
                        <maecPackage:Tool id="analysis-tool-1">
                        <cyboxCommon:Name>PEiD</cyboxCommon:Name>
                        <cyboxCommon:Version>0.94</cyboxCommon:Version>
                        </maecPackage:Tool>
                        </maecPackage:Tools>
                    </maecPackage:Analysis>
                    </maecPackage:Analyses>
   
                    <maecPackage:Findings_Bundles>
                    <maecPackage:Bundle id="maec-example-bnd-1" schema_version="4.1" defined_subject="false" content_type="extracted from subject">
                        <maecBundle:Objects>
                        <maecBundle:Object id="maec-example-obj-1">
                        <cybox:Properties xsi:type="WinExecFileObj:WindowsExecutableFileObjectType">
                            <WinExecFileObj:Headers>
                            <WinExecFileObj:Optional_Header>
                            <WinExecFileObj:Major_Linker_Version>06</WinExecFileObj:Major_Linker_Version>
                            <WinExecFileObj:Minor_Linker_Version>00</WinExecFileObj:Minor_Linker_Version>
                            <WinExecFileObj:Base_Of_Code>036418</WinExecFileObj:Base_Of_Code>
                            <WinExecFileObj:Subsystem>Windows_GUI</WinExecFileObj:Subsystem>
                            </WinExecFileObj:Optional_Header>
                            </WinExecFileObj:Headers>
                            <WinExecFileObj:Type>Executable</WinExecFileObj:Type>
                        </cybox:Properties>
                        </maecBundle:Object>
                        </maecBundle:Objects>
                    </maecPackage:Bundle>
                    </maecPackage:Findings_Bundles>
                    </maecPackage:Malware_Subject>
                    </maecPackage:Malware_Subjects>
                </stix-maec:MAEC></stix-maec:MAEC4.1InstanceType>"""

class IdentityTests(EntityTestCase, unittest.TestCase):
    klass = MAECInstance
    try:
        import maec
        _full_dict = {'xsi:type': 'stix-maec:MAEC4.1InstanceType', 
                        'maec': {'malware_subjects': [{'malware_instance_object_attributes': 
                                                    {'id': 'maec-tst-obj-1', 
                                                        'properties': {'hashes': 
                                                                    [{'simple_hash_value': '9d7006e30fdf15e9c8e03e62534b3a3e', 'type': 'MD5'}], 
                                                                        'xsi:type': 'FileObjectType'}}}]}}
    except ImportError:
        _full_dict = {'xsi:type': 'stix-maec:MAEC4.1InstanceType',
                      'maec' : STIX_MAEC_XML}

    def test_etree_export(self):
        from lxml import etree
        maec_malware_instance = MAECInstance()
        maec_malware_instance.maec = etree.fromstring(MAEC_XML, parser=etree.ETCompatXMLParser())
        self.assertEqual(maec_malware_instance.to_xml(pretty=False), MALWARE_INSTANCE_OUT)

if __name__ == "__main__":
    unittest.main()