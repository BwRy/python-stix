import unittest
from stix.test import EntityTestCase
from stix.extensions.malware.maec_4_1_malware import MAECInstance

STIX_MAEC_XML = """<stix-maec:MAEC xmlns:maecPackage="http://maec.mitre.org/XMLSchema/maec-package-2" xmlns:maecBundle="http://maec.mitre.org/XMLSchema/maec-bundle-4" xmlns:maecVocabs="http://maec.mitre.org/default_vocabularies-1" xmlns:cybox="http://cybox.mitre.org/cybox-2" xmlns:cyboxCommon="http://cybox.mitre.org/common-2" xmlns:cyboxVocabs="http://cybox.mitre.org/default_vocabularies-2" xmlns:FileObj="http://cybox.mitre.org/objects#FileObject-2" xmlns:WinExecFileObj="http://cybox.mitre.org/objects#WinExecutableFileObject-2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:stix-maec="http://stix.mitre.org/extensions/Malware#MAEC4.1-1" xsi:schemaLocation="http://maec.mitre.org/XMLSchema/maec-package-2 http://maec.mitre.org/language/version4.1/maec_package_schema.xsd                     http://maec.mitre.org/default_vocabularies-1 http://maec.mitre.org/language/version4.1/maec_default_vocabularies.xsd                     http://cybox.mitre.org/default_vocabularies-2 http://cybox.mitre.org/XMLSchema/default_vocabularies/2.1/cybox_default_vocabularies.xsd                      http://cybox.mitre.org/objects#WinExecutableFileObject http://cybox.mitre.org/XMLSchema/objects/Win_Executable_File/2.1/Win_Executable_File_Object.xsd" id="maec-example-pkg-1" schema_version="2.1">
                   </stix-maec:MAEC>"""

MAEC_XML = """<maecPackage:MAEC_Package
                    xmlns:maecPackage="http://maec.mitre.org/XMLSchema/maec-package-2"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maec.mitre.org/XMLSchema/maec-package-2 http://maec.mitre.org/language/version4.1/maec_package_schema.xsd" 
                    id="maec-example-pkg-1" schema_version="2.1">
                </maecPackage:MAEC_Package>"""

MAEC_INSTANCE_OUT = """<stix-maec:MAEC4.1InstanceType  xmlns:cyboxCommon="http://cybox.mitre.org/common-2" xmlns:cybox="http://cybox.mitre.org/cybox-2" xmlns:cyboxVocabs="http://cybox.mitre.org/default_vocabularies-2" xmlns:example="http://example.com" xmlns:ttp="http://stix.mitre.org/TTP-1" xmlns:stixCommon="http://stix.mitre.org/common-1" xmlns:stixVocabs="http://stix.mitre.org/default_vocabularies-1" xmlns:stix-maec="http://stix.mitre.org/extensions/Malware#MAEC4.1-1" xmlns:stix="http://stix.mitre.org/stix-1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation=" http://cybox.mitre.org/common-2 http://cybox.mitre.org/XMLSchema/common/2.1/cybox_common.xsd http://cybox.mitre.org/cybox-2 http://cybox.mitre.org/XMLSchema/core/2.1/cybox_core.xsd http://cybox.mitre.org/default_vocabularies-2 http://cybox.mitre.org/XMLSchema/default_vocabularies/2.1/cybox_default_vocabularies.xsd http://maec.mitre.org/XMLSchema/maec-package-2 http://maec.mitre.org/language/version4.1/maec_package_schema.xsd http://stix.mitre.org/TTP-1 http://stix.mitre.org/XMLSchema/ttp/1.1.1/ttp.xsd http://stix.mitre.org/common-1 http://stix.mitre.org/XMLSchema/common/1.1.1/stix_common.xsd http://stix.mitre.org/default_vocabularies-1 http://stix.mitre.org/XMLSchema/default_vocabularies/1.1.1/stix_default_vocabularies.xsd http://stix.mitre.org/extensions/Malware#MAEC4.1-1 http://stix.mitre.org/XMLSchema/extensions/malware/maec_4.1/1.0.1/maec_4.1_malware.xsd http://stix.mitre.org/stix-1 http://stix.mitre.org/XMLSchema/core/1.1.1/stix_core.xsd" xsi:type='stix-maec:MAEC4.1InstanceType'><stix-maec:MAEC xmlns:maecPackage="http://maec.mitre.org/XMLSchema/maec-package-2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:stix-maec="http://stix.mitre.org/extensions/Malware#MAEC4.1-1" xsi:schemaLocation="http://maec.mitre.org/XMLSchema/maec-package-2 http://maec.mitre.org/language/version4.1/maec_package_schema.xsd" id="maec-example-pkg-1" schema_version="2.1">
                </stix-maec:MAEC></stix-maec:MAEC4.1InstanceType>"""

class IdentityTests(EntityTestCase, unittest.TestCase):
    klass = MAECInstance
    try:
        import maec
        _full_dict = {'xsi:type': 'stix-maec:MAEC4.1InstanceType', 
                        'maec': {'malware_subjects': [{'malware_instance_object_attributes': 
                                                    {'id': 'maec-tst-obj-1', 
                                                        'properties': {'hashes': 
                                                                    [{'simple_hash_value': '9d7006e30fdf15e9c8e03e62534b3a3e', 'type': 'MD5'}], 
                                                                        'xsi:type': 'FileObjectType'}}}]}}
    except ImportError:
        _full_dict = {'xsi:type': 'stix-maec:MAEC4.1InstanceType',
                      'maec' : STIX_MAEC_XML}

    def test_etree_export(self):
        from lxml import etree
        maec_malware_instance = MAECInstance()
        maec_malware_instance.maec = etree.fromstring(MAEC_XML, parser=etree.ETCompatXMLParser())
        self.assertEqual(maec_malware_instance.to_xml(pretty=False), MAEC_INSTANCE_OUT)

if __name__ == "__main__":
    unittest.main()